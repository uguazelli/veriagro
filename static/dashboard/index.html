<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css" rel="stylesheet" />
    <title>VeriAgro - Devices</title>
</head>

<body>
    <div class="page">
        <header class="navbar navbar-expand-md d-print-none">
            <div class="container-xl">
                <a class="navbar-brand navbar-brand-autodark me-3" href="#">VeriAgro</a>
            </div>
        </header>

        <div class="page-wrapper">
            <div class="page-body">
                <div class="container-xl">
                    <div class="row row-deck row-cards">
                        <!-- Device Form -->
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Add a New Device</h3>
                                </div>
                                <div class="card-body">
                                    <form class="row g-3" id="device-form">
                                        <div class="col-auto"><input class="form-control" id="name"
                                                placeholder="Device Name" type="text" /></div>
                                        <div class="col-auto"><input class="form-control" id="model" placeholder="Model"
                                                type="text" /></div>
                                        <div class="col-auto"><input class="form-control" id="serial_number"
                                                placeholder="Serial Number" type="text" /></div>
                                        <div class="col-auto"><input class="form-control" id="location"
                                                placeholder="Location" type="text" /></div>
                                        <div class="col-auto"><input class="form-control" id="latitude"
                                                placeholder="Latitude" type="text" /></div>
                                        <div class="col-auto"><input class="form-control" id="longitude"
                                                placeholder="Longitude" type="text" /></div>
                                        <div class="col-auto"><button class="btn btn-primary" type="submit">Add
                                                Device</button></div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Device Table -->
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Devices</h3>
                                </div>
                                <div class="card-body" id="devices-table-container">Loading...</div>
                            </div>
                        </div>
                    </div> <!-- /row -->
                </div> <!-- /container -->
            </div> <!-- /page-body -->
        </div> <!-- /page-wrapper -->
    </div> <!-- /page -->

    <script>
        const token = localStorage.getItem("accessToken");
        const API_URL = "http://localhost:8000";

        function requireAuth() {
            if (!token) {
                window.location.href = "/login";
            }
        }

        async function loadDevices() {
            try {
                const res = await fetch(`${API_URL}/devices/`, {
                    headers: { Authorization: `Bearer ${token}`, Accept: "application/json" }
                });
                const data = await res.json();
                renderDevices(data);
            } catch (e) {
                console.error("Error loading devices", e);
            }
        }

        function renderDevices(devices) {
            const container = document.getElementById("devices-table-container");
            const table = document.createElement("table");
            table.className = "table table-striped";
            table.innerHTML = `
        <thead>
          <tr><th>Name</th><th>Model</th><th>Serial</th><th>Location</th><th>Lat</th><th>Long</th></tr>
        </thead>
        <tbody>
          ${devices.map(d => `
            <tr data-id="${d.id}">
              <td>${d.name}</td>
              <td>${d.model}</td>
              <td>${d.serial_number}</td>
              <td>${d.location}</td>
              <td>${d.latitude}</td>
              <td>${d.longitude}</td>
            </tr>
          `).join("")}
        </tbody>
      `;

            const wrapper = document.createElement("div");
            wrapper.className = "table-responsive";
            wrapper.appendChild(table);
            container.innerHTML = "";
            container.appendChild(wrapper);

            // Navigate to /sensor/{id} on row click
            table.querySelectorAll("tr[data-id]").forEach(row => {
                row.addEventListener("click", () => {
                    const deviceId = row.dataset.id;
                    window.location.href = `/sensor/${deviceId}`;
                });
            });
        }

        document.addEventListener("DOMContentLoaded", () => {
            requireAuth();
            loadDevices();
        });
    </script>
</body>

</html>